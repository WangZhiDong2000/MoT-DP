
dataloader:
  batch_size: 128              # 增加批大小以减少epoch中的batch数
  num_workers: 8               # 增加工作进程数以加速数据加载
  persistent_workers: True     # 保持工作进程以避免启动/销毁开销
  pin_memory: true             # 锁定内存以加速GPU传输
  prefetch_factor: 2           # 预取因子，提前加载下个batch
  shuffle: true

# Horizon settings 
obs_horizon: 2         
pred_horizon: 8        
action_horizon: 4      
n_obs_steps: 2

# EMA settings
ema:
  inv_gamma: 1.0
  max_value: 0.9999
  min_value: 0.0
  power: 0.75
  update_after_step: 0

# Optimizer settings
optimizer:
  _target_: torch.optim.AdamW
  betas:
  - 0.9        
  - 0.999
  eps: 1.0e-08
  lr: 5.0e-05  
  weight_decay: 1.0e-05  # weight decay防止过拟合

# Shape meta - CARLA数据集
shape_meta:
  action:
    shape:
    - 2           
  obs:
    agent_pos:
      shape:
      - 2
      type: low_dim
    image:
      shape:
      - 3
      - 96
      - 96
      type: rgb
    speed:
      shape:
      - 1
      type: low_dim
    theta:
      shape:
      - 1  
      type: low_dim
    target_point:
      shape:
      - 2
      type: low_dim

# Action normalization settings
enable_action_normalization: true  

# BEV Encoder configuration
bev_encoder:
  pretrained_path: '/home/wang/Project/MoT-DP/model/interfuser/lidar_bev_encoder_only.pth'
  state_dim: 9           # speed(1) + target_point(2) + command(6)
  feature_dim: 256
  use_group_norm: true
  freeze_backbone: false
  bev_input_size: [448, 448]

# Policy configuration for DiT 
policy:
  input_dim: 2        # action_dim 
  output_dim: 2       # action_dim  
  horizon: 8          # 与action_horizon保持一致
  n_obs_steps: 2      # obs_horizon
  cond_dim: 256       # TCP模型j_ctrl特征维度
  obs_as_global_cond: true
  
  # Transformer architecture 
  n_layer: 8          
  n_head: 8           
  n_emb: 512          
  p_drop_emb: 0.1    
  p_drop_attn: 0.1   
  
  # Attention settings
  causal_attn: true
  time_as_cond: true
  obs_as_cond: true
  n_cond_layers: 4    
  action_horizon: 4
  num_inference_steps: 100

# Controller configuration - PID 控制器参数
controller:
  # Turn controller (转向控制器)
  turn_KP: 0.75         # 转向 Proportional 增益
  turn_KI: 0.75         # 转向 Integral 增益
  turn_KD: 0.3          # 转向 Derivative 增益
  turn_n: 40            # 转向控制器窗口大小
  
  # Speed controller (速度控制器)
  speed_KP: 5.0         # 速度 Proportional 增益
  speed_KI: 0.5         # 速度 Integral 增益
  speed_KD: 1.0         # 速度 Derivative 增益
  speed_n: 40           # 速度控制器窗口大小
  
  # Trajectory planning parameters (轨迹规划参数)
  aim_dist: 4.0         # 目标距离 - 搜索aim point的距离范围
  angle_thresh: 0.3     # 角度阈值 - 异常控制检测的角度阈值
  dist_thresh: 10.0     # 距离阈值 - 用于异常过滤的目标点y距离
  
  # Brake and throttle parameters (制动和油门参数)
  brake_speed: 0.4      # 制动速度阈值 - 低于此速度时触发制动
  brake_ratio: 1.1      # 制动比率 - 速度/期望速度的比率，超过此值触发制动
  clip_delta: 0.25      # 速度差值剪切范围 - 纵向控制器的最大速度变化
  max_throttle: 0.75    # 最大油门 - 数据集中油门信号的上限  

# Noise scheduler configuration 
noise_scheduler:
  num_diffusion_steps: 100    
  beta_start: 0.0001
  beta_end: 0.02
  beta_schedule: "squaredcos_cap_v2"  
  clip_sample: false
  prediction_type: "epsilon" # 预测目标为噪声/目标动作

# Training settings 
training:
  num_epochs: 300            
  max_grad_norm: 1.0        
  dataset_path: '/home/wang/Project/carla_garage/tmp_data'  
  # dataset_path: '/home/wang/Dataset/b2d_10scene/tmp_data' 
  image_data_root: '/home/wang/Project/carla_garage/data'  
  # image_data_root: '/home/wang/Dataset/b2d_10scene'
  sample_interval: 1         # 增加采样间隔以减少数据量
  lr_final: 1e-7           
  validation_freq: 3         # 每隔3个epoch进行一次评估
  save_freq: 3               # 每隔3个epoch保存一次checkpoint
  early_stopping_patience: 10  

# Logging - wandb配置
logging:
  use_wandb: true
  wandb_project: "carla-diffusion-policy"
  run_name: "carla_dit_optimized"
  checkpoint_dir: "/home/wang/Project/MoT-DP/checkpoints/carla_dit_best"
  save_every: 5
  log_freq: 10             

# Evaluation settings 
eval:
  num_episodes: 10         
  max_steps: 500          
  success_threshold: 0.1   
  eval_freq: 10            

# Data augmentation 
data_augmentation:
  enable: true
  image_noise_std: 0.02   
  action_noise_std: 0.01 
  random_crop: false      

# Model optimization 
model_optimization:
  use_mixed_precision: true    # 使用混合精度训练
  gradient_accumulation_steps: 2  # 梯度累积步数
  warmup_steps: 500           # 学习率预热步数
  lr_scheduler: "cosine"      # 余弦学习率调度